{% extends 'base.html' %}

{% load static %}
{% block content %}
<body>
<div class="container-fluid mt-4">
  <div class="starry-bg" id="stars"></div>
  <h1>üêçSnake Game</h1>
  <div style="display: flex; justify-content: center; align-items: center;">
    <div class="game-wrapper">
      <div id="snakeImage"><img src="{% static 'images/snake-image.png' %}" alt="Snake Game Icon"></div>
      <button id="startBtn">Start Game</button>
      <canvas id="gameCanvas" width="400" height="400"></canvas>
      <p id="scoreDisplay">Score: <span id="score">0</span></p>
      <!-- <a id ="home-link" href="index.html">‚¨Ö Back to Arcade Menu</a> -->
    </div>
    <aside style="width: 250px; background: #222; color: #fff; border-radius: 8px; padding: 16px; box-shadow: 0 0 8px #000; margin-left: 80px;">
      <h3 style="text-align:center;">Top 10 Scores</h3>
      <ol id="scoreboard-list" style="padding-left: 20px;">
        {% for score in top_scores %}
          <li>
            {{ score.gamer.username }}: {{ score.score }}
            {% if user.is_authenticated and score.gamer == user %}
              <button class="delete-score-btn" data-score-id="{{ score.id }}" style="background:none;border:none;color:#F25F4C;cursor:pointer;">Delete</button>
            {% endif %}
          </li>
        {% empty %}
          <li>No scores yet.</li>
        {% endfor %}
      </ol>
    </aside>
  </div>
</div>
    <!-- üå† Twinkling Stars + Shooting Star script generated by AI -->
  <script>
    const starContainer = document.getElementById('stars');

    for (let i = 0; i < 60; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      star.style.top = `${Math.random() * 100}vh`;
      star.style.left = `${Math.random() * 100}vw`;
      star.style.animationDuration = `${1 + Math.random() * 2}s`;
      starContainer.appendChild(star);
    }

    setInterval(() => {
      const shootingStar = document.createElement('div');
      shootingStar.classList.add('shooting-star');
      shootingStar.style.top = `${Math.random() * 80}vh`;
      shootingStar.style.left = `-${Math.random() * 100}px`;

      starContainer.appendChild(shootingStar);

      setTimeout(() => {
        shootingStar.remove();
      }, 3000);
    }, 4000);

    // Remove snake image when Start Game is clicked
    document.getElementById('startBtn').addEventListener('click', function() {
      const snakeImageDiv = document.getElementById('snakeImage');
      if (snakeImageDiv) {
        snakeImageDiv.remove();
      }
    });
  </script>

<!-- üêç Snake Game Logic -->
  <script src="static/js/script.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      function updateScoreboard() {
        fetch('/get-top-scores/')
          .then(response => response.json())
          .then(data => {
            const scoresList = document.getElementById('scoreboard-list');
            if (scoresList) {
              let html = '';
              if (data.top_scores.length > 0) {
                data.top_scores.forEach(item => {
                  html += `<li>${item.username}: ${item.score}`;
                  if (item.is_owner) {
                    html += ` <button class='delete-score-btn' data-score-id='${item.id}' style='background:none;border:none;color:#F25F4C;cursor:pointer;'>Delete</button>`;
                  }
                  html += `</li>`;
                });
              } else {
                html = '<li>No scores yet.</li>';
              }
              scoresList.innerHTML = html;
              attachDeleteHandlers();
            }
          });
      }

      function attachDeleteHandlers() {
        document.querySelectorAll('.delete-score-btn').forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to delete this score?')) {
              if (confirm('This action cannot be undone. Delete anyway?')) {
                const scoreId = btn.getAttribute('data-score-id');
                fetch(`/delete-score/${scoreId}/`, {
                  method: 'POST',
                  headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken'),
                  },
                })
                .then(response => response.json())
                .then(data => {
                  if (data.status === 'success') {
                    updateScoreboard();
                  } else {
                    alert('Could not delete score.');
                  }
                });
              }
            }
          });
        });
      }

      // Update scoreboard after saving score
      window.updateScoreboard = updateScoreboard;
      attachDeleteHandlers();
    });

    // Helper to get CSRF token from cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.delete-score-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const scoreId = btn.getAttribute('data-score-id');
          fetch(`/delete-score/${scoreId}/`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': getCookie('csrftoken'),
            },
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              btn.parentElement.remove();
            } else {
              alert('Could not delete score.');
            }
          });
        });
      });
    });

    // Helper to get CSRF token from cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>


</body>

{% endblock %}